from debug import *
from string import ascii_uppercase, digits
import random
from icecream import ic


alphabet = ascii_uppercase + digits

# p, q, g = domain_params_generation()
q = 62836028903169909872386195309975884821422518101450242726359440995198732322309
p = 16566809250264108378903969549066274751014245426755523879267134864883134849465909976189256614120185783047720522603145640771485661839108313438783304141716265887708381030037932882250921951890574107100758481097047050708814231576233223997910780112337758996690202460944901823227626188518977264948402889619736477850986403125123745949818246010394154030987136867746680262927256634141059615249765638827548664837940890031627501208132404850781859319681282283914357864280483712774824219039364135640624514266737810934831610784621383796813826533664229966838367076107529360913358043158068914251172218416377684595029543000856358029523
g = 2886839616857250469279435955083104515363804425655888084131712897196165998510161787558049602817868534191387802713141466532765263234731007894588573081387346294763480728083386964816862135812488990378363282465319214497925803345933212344010989968198065021537534637418917740639998413467801316839231642247382861631444685703056019353716807208114572792727395429098872467713070748282653789745762500964902209166658435026834874595428063041939394382745638095697237279337856089524954316377285831172490869601267206914017684070226242817710710013999614631877615176489690150395424379916718988236671234743899883534344224168675573596399

# x, y = key_generation(p, q, g)
# ic(x, y)
x = 59781710087381405612779710677557435779316646925337098562255365519667908844104
y = 932015958660691586669756906320609754671728388267270608332695193848262715770837684607688745279044770269216907030725778083390804632731516366195331694801874547581067254928787355518158599987576852235905288234299382032332529248482908388971034668617575077065933027516070887432178083762973927266268602895092069095101355496202256894507615754929750288152674815821863802752283375203325309227861855712027693994528649105258245678506413828032218283303620070564344607405459955844683891069327126832895888264543623547971814925437727055153616571106708869760037957572564402961890411398548120461878932258887949348688740974198940548306

x_bytes = long_to_bytes(x)
ic(len(x_bytes))
xp = bytes_to_long(x_bytes[:4] + b'\x00' + b'\x00' * 27)
ic(x)
ic(xp)

def get_message():
    return ''.join(random.choices(alphabet, k=50))

        
m = get_message()
ic(m)

k = getRandomRange(1, q-1)

k_lsb = bin(k)[-16:]
k_msb = bin(k)[2:18]
ic(k_msb)
ic(k_lsb)

r = 0
while r == 0:
    r = int(pow(g, k, p)) % q

s = 0
while s == 0:
    Hm = int(sha512(m.encode('utf-8')).hexdigest(), 16)
    s = (inverse(k, q) * (Hm + x*r)) % q

ic(r, s)


k_guess = ((Hm + xp*r) * inverse(s, q)) % q
k_guess_lsb = bin(k_guess)[-16:]
k_guess_msb = bin(k_guess)[2:18]
ic(k_guess_msb)
ic(k_guess_lsb)
